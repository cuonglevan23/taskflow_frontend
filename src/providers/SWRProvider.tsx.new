"use client";

import { SWRConfig } from 'swr';
import { ReactNode, useEffect } from 'react';
import { withSessionCaching, initializeSessionCache } from '@/lib/middleware/sessionCaching';

interface SWRProviderProps {
  children: ReactNode;
}

// Global SWR configuration optimized for Next.js 15+
export function SWRProvider({ children }: SWRProviderProps) {
  // Initialize session caching on client side
  useEffect(() => {
    initializeSessionCache();
  }, []);

  return (
    <SWRConfig
      value={{
        // Cache optimization
        revalidateOnFocus: false,           // Disable focus revalidation globally
        revalidateOnReconnect: false,       // Disable reconnect revalidation
        revalidateIfStale: false,           // Disable stale revalidation
        
        // Deduplication settings - Aggressive caching for team data
        dedupingInterval: 300000,           // 5 minutes global deduping for team data persistence
        
        // Error handling
        errorRetryCount: 2,
        errorRetryInterval: 3000,
        
        // Performance optimizations
        refreshInterval: 0,                 // Disable auto refresh
        keepPreviousData: true,             // Keep previous data during revalidation
        
        // Network optimization
        loadingTimeout: 5000,               // 5 second timeout
        
        // Next.js 15+ optimizations
        suspense: false,                    // Disable suspense for better control
        
        // Enhanced fetcher with session caching middleware
        fetcher: (url: string) => {
          const fetchFn = () => fetch(url).then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
          });
          
          // Apply session caching middleware
          return withSessionCaching(fetchFn)();
        },
        
        // Performance monitoring (can be removed in production)
        onError: (error, key) => {
          if (process.env.NODE_ENV === 'development') {
            console.error(`❌ SWR Error: ${Array.isArray(key) ? key.join(',') : key}`, error);
          }
        },
      }}
    >
      {children}
    </SWRConfig>
  );
}
